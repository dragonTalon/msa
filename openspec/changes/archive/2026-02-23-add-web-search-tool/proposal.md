# 提案：add-web-search-tool

为 MSA 股票分析 Agent 添加基于 chromedp 的网页搜索能力，使其能够获取最新的市场信息作为分析参考。

## 知识上下文

### 相关历史问题

知识库中未找到与 web 搜索、chromedp 或浏览器自动化相关的历史问题。

### 需避免的反模式

未识别到特定反模式。

### 推荐模式

未识别到特定模式。

**知识备注**：这是新领域的功能开发。在实现过程中如遇到问题，请创建 `fix.md` 文档来构建知识库，帮助未来避免重复问题。

## 为什么

MSA 作为一个股票分析 Agent，目前只能访问工具提供的结构化数据（如股票代码、K线数据等），无法获取实时的市场新闻、公司公告、行业动态等非结构化信息。这些信息对于准确的股票分析至关重要。

例如：
- 公司突然发布财报预警
- 行业政策发生重大变化
- 竞争对手发布重要产品
- 宏观经济数据发布

通过添加网页搜索能力，Agent 可以主动获取这些信息，提供更全面、及时的分析建议。

**为什么现在做**：
- MSA 的基础工具框架已经成熟（`MsaTool` 接口、工具注册机制）
- 已有的 stock 工具提供了良好的设计参考
- 用户对实时信息的需求日益增长

## 变更内容

- **新增 web_search 工具**：基于 Google 搜索引擎，返回搜索结果的标题、URL、摘要
- **新增 fetch_page_content 工具**：使用 chromedp 渲染网页，提取正文内容
- **新增工具组**：创建 `search` 工具组（`model.SearchToolGroup`）
- **浏览器抽象层**：封装 chromedp 操作，提供简洁的接口
- **搜索引擎接口**：设计可扩展的搜索引擎接口（优先实现 Google）
- **内容提取器**：通用的 HTML 内容提取逻辑（去除脚本、样式等）

## 能力

### 新增能力

- `web-search`：互联网搜索能力，支持通用网页搜索和结果获取
- `web-scraping`：网页内容抓取能力，支持渲染页面和文本提取

### 修改能力

无。此变更不修改现有能力的需求。

## 影响

### 代码结构

```
pkg/logic/tools/search/  (新增目录)
├── search.go           # web_search 工具实现
├── fetcher.go          # fetch_page_content 工具实现
├── browser.go          # chromedp 封装
├── google.go           # Google 搜索引擎实现
├── extractor.go        # 内容提取器
└── models.go           # 数据结构定义

pkg/logic/tools/register.go  (修改)
├── 注册 search 工具组
└── 注册新的工具

pkg/model/  (可能修改)
├── 新增 SearchToolGroup 常量
└── 可能新增搜索相关的数据模型
```

### 依赖

- **chromedp**：Go 的 Chrome DevTools Protocol 客户端
- **net/html**：HTML 解析（标准库）
- 可能需要 **chromium/chrome** 浏览器（用户环境）

### API

- 工具接口遵循现有的 `MsaTool` 接口规范
- Agent 调用方式与现有 stock 工具一致

### 性能

- 搜索操作预计 2-5 秒（包含浏览器启动和页面加载）
- 首次调用较慢（启动浏览器），后续调用会复用实例
- 内存占用增加约 50-100MB（Chrome headless 实例）

### 用户体验

- Agent 可以回答"最新消息"、"现在有什么新闻"等问题
- 分析股票时可以结合最新资讯
- 响应时间会比纯数据查询慢（需提前告知用户）

## 设计原则

基于探索阶段的讨论，此变更遵循以下设计原则：

1. **通用优先，垂直后置**：
   - Phase 1 实现通用网页搜索和内容抓取
   - Phase 2 根据实际使用数据添加财经专用优化

2. **两步提取策略**：
   - Stage 1：快速返回搜索结果摘要（title, url, snippet）
   - Stage 2：按需抓取完整页面内容

3. **可扩展性**：
   - SearchEngine 接口便于添加其他搜索引擎（Bing, Baidu）
   - Extractor 接口便于添加垂直领域提取器
   - Browser 接口便于替换实现

4. **简洁性**：
   - 工具接口参数最小化
   - 固定返回 10 条搜索结果
   - 默认提取 5000 字符内容

## 不在范围

以下功能有意排除在 Phase 1 之外：

- 财经新闻专用提取器（留待 Phase 2）
- 搜索结果智能重排序
- 内容去重和聚合
- 结果缓存机制
- 多搜索引擎并行
- 复杂的内容分页逻辑

这些功能可以在上线后根据实际使用数据和用户反馈进行迭代。
