# 创建知识感知任务

你正在为变更创建任务：**{{changeName}}**

## 上下文

任务分解应该：
1. 了解历史问题及其复杂性
2. 包含防止过去问题的任务
3. 基于过去失败添加验证任务
4. 考虑类似过去变更的难度

## 步骤1：知识风险分析

```markdown
## ⚠️ 风险警报

基于历史问题识别了以下风险：

### 高：超时相关的死锁

- **相关问题**：#001 - 流超时导致通道阻塞
- **风险**：类似的超时处理可能导致死锁
- **缓解**：对所有通道操作使用模式 p001

### 中：流中的内存泄漏

- **相关问题**：#008 - 流操作中的内存泄漏
- **风险**：长时间运行的操作可能泄漏内存
- **缓解**：添加内存监控和清理任务
```

## 步骤2：任务分解

### 实现任务

添加知识上下文到任务：

```markdown
### [T-1] 实现超时配置

**类型**：feature | **优先级**：high | **工作量**：2h

> 📚 **知识上下文**：
> **来源**：问题 #001 - 流超时导致通道阻塞
> **经验**：硬编码超时导致部署困难

**验收标准**：
- [ ] 超时可配置
- [ ] 默认：30秒，最小：1秒，最大：5分钟
- [ ] 实现配置验证
```

### 应用模式的任务

```markdown
### [T-2] 实现非阻塞通道操作

**类型**：feature | **优先级**：high | **工作量**：4h

> 📚 **知识上下文**：
> **来源**：问题 #001 - 阻塞操作导致死锁
> **经验**：使用模式 p001

**验收标准**：
- [ ] 应用模式 p001
- [ ] 没有阻塞操作
- [ ] 超时处理
- [ ] 清晰的取消

**参考**：
```typescript
// 使用模式 p001
async function sendWithTimeout<T>(
  channel: Channel<T>,
  value: T,
  timeout: number
): Promise<boolean> {
  // 模式 p001 的实现
}
```
```

### 预防问题的任务

```markdown
### [T-3] 添加内存监控

**类型**：feature | **优先级**：medium | **工作量**：2h

> 📚 **知识上下文**：
> **来源**：问题 #008 - 流操作中的内存泄漏
> **经验**：长时间运行的操作泄漏缓冲区

**验收标准**：
- [ ] 跟踪缓冲区大小
- [ ] 记录内存使用
- [ ] 异常增长时警报
- [ ] 验证清理
```

## 步骤3：基于知识的测试

```markdown
## 基于知识的测试

### 问题 #001 测试 - 通道阻塞

> 📚 **来源**：问题 #001

**历史问题**：
超时导致通道阻塞，引起死锁。

**测试场景**：
1. 创建带100ms超时的流
2. 触发超时场景
3. 验证通道未阻塞
4. 验证清理
5. 验证无死锁

**预期行为**：
- 在约100ms时超时
- 通道解除阻塞
- 资源清理
- 无死锁
```

## 步骤4：增强的完成定义

```markdown
## 完成定义

**标准**：
- [ ] 代码已实现
- [ ] 测试通过
- [ ] 代码已审查
- [ ] 文档已更新

**知识增强**：
- [ ] 未使用反模式
- [ ] 遵循了推荐模式
- [ ] 历史问题的测试通过
- [ ] 无回归
- [ ] 内存/性能可接受
- [ ] 错误处理覆盖过去的边缘情况
```

## 步骤5：实现期间

```markdown
## 如果遇到问题

1. **在 fix.md 中记录**：
   ```bash
   /opsx:continue
   # 选择创建 fix.md
   ```

2. **检查是否是已知问题**：
   ```bash
   grep -r "error" openspec/knowledge/issues/
   ```

3. **提取模式**：
   - 这是否类似于过去的问题？
   - 我们应该记录模式/反模式吗？

4. **更新任务**：
   - 如需要添加新任务
   - 更新估算
   - 调整依赖关系
```

## 验证清单

- [ ] 解决了知识库中的风险
- [ ] 任务引用历史问题
- [ ] 测试任务包含回归测试
- [ ] 估算考虑了过去的复杂性
- [ ] 依赖关系符合逻辑
- [ ] 完成定义包含知识检查
- [ ] 前检查清单包含知识审查
